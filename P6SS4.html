<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/style.css" />
    <title>Admin Panel - Applications</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
      }

      .header {
        background: transparent;
        color: black;
        text-align: center;
        padding: 1rem 0;
        font-size: 1.5rem;
      }

      table {
        width: 90%;
        margin: 20px auto;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        padding: 12px;
        text-align: center;
        border: 1px solid #ddd;
      }

      th {
        background: #004c86;
        color: white;
      }

      td button {
        padding: 8px 12px;
        background: #004c86;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.3s ease;
      }

      td button:hover {
        background: #001a2e;
      }

      /* Popup styles */
      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        width: 400px;
        z-index: 1000;
        border-radius: 8px;
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }

      .popup.active {
        display: block;
      }

      .popup h2 {
        margin-top: 0;
        color: #004c86;
        font-size: 1.5rem;
      }

      .popup p {
        margin: 10px 0;
      }

      .popup button {
        margin-top: 15px;
        padding: 10px 15px;
        background: #004c86;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.3s ease;
        width: 48%;
        display: inline-block;
      }

      .popup button:hover {
        background: #00243f;
      }

      .popup .button-secondary {
        background: #ccc;
        color: black;
      }

      .popup .button-secondary:hover {
        background: #bbb;
      }

      .popup .button-danger {
        background: red;
        color: white;
      }

      .popup .button-danger:hover {
        background: darkred;
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .overlay.active {
        display: block;
      }

      select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
      }

      select.not-read {
        background-color: black;
        color: white;
      }

      select.accepted {
        background-color: green;
        color: black;
      }

      select.rejected {
        background-color: red;
        color: black;
      }
    </style>
  </head>
  <body>
    <script src="navbar.js"></script>

    <header class="header">
      <h1>Admin Panel - Applications</h1>
    </header>
    <main>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Job Title</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applications-table">
          <!-- Applications will be dynamically inserted here -->
        </tbody>
      </table>
    </main>

    <!-- View Application Popup -->
    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
      <h2>Application Details</h2>
      <p><strong>Name:</strong> <span id="popup-name"></span></p>
      <p><strong>Email:</strong> <span id="popup-email"></span></p>
      <p><strong>Job Title:</strong> <span id="popup-job-title"></span></p>
      <p><strong>Resume:</strong> <span id="popup-resume"></span></p>
      <button id="close-popup" class="button-secondary">Close</button>
    </div>

    <!-- Delete Confirmation Popup -->
    <div class="popup" id="delete-popup">
      <h2>Confirm Deletion</h2>
      <p>Are you sure you want to delete this application?</p>
      <button id="confirm-delete" class="button-danger">Delete</button>
      <button id="cancel-delete" class="button-secondary">Cancel</button>
    </div>

    <script>
      const table = document.getElementById("applications-table");
      const popup = document.getElementById("popup");
      const deletePopup = document.getElementById("delete-popup");
      const overlay = document.getElementById("overlay");
      let emailToDelete = null;

      function getStatusClass(status) {
        switch (status) {
          case "Accepted":
            return "accepted";
          case "Rejected":
            return "rejected";
          case "Not-Read":
          default:
            return "not-read";
        }
      }

      async function fetchApplications() {
        const response = await axios.get(
          "/.netlify/functions/get-applications"
        );
        const applications = response.data;

        table.innerHTML = "";
        applications.forEach((app) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${app.name}</td>
            <td>${app.email}</td>
            <td>${app.jobTitle}</td>
            <td>
              <select class="${getStatusClass(
                app.status
              )}" onchange="updateStatus(this, '${app.email}')">
                <option value="Not-Read" ${
                  app.status === "Not-Read" ? "selected" : ""
                }>Not-Read</option>
                <option value="Accepted" ${
                  app.status === "Accepted" ? "selected" : ""
                }>Accepted</option>
                <option value="Rejected" ${
                  app.status === "Rejected" ? "selected" : ""
                }>Rejected</option>
              </select>
            </td>
            <td>
              <button onclick='viewApplication(${JSON.stringify(
                app
              )})'>View</button>
              <button onclick='confirmDelete("${app.email}")'>Delete</button>
            </td>
          `;
          table.appendChild(row);

          const dropdown = row.querySelector("select");
          dropdown.addEventListener("change", (e) => {
            dropdown.className = getStatusClass(e.target.value);
          });
        });
      }

      function viewApplication(app) {
        document.getElementById("popup-name").textContent = app.name;
        document.getElementById("popup-email").textContent = app.email;
        document.getElementById("popup-job-title").textContent = app.jobTitle;
        document.getElementById("popup-resume").textContent = app.resume;

        popup.classList.add("active");
        overlay.classList.add("active");
      }

      function confirmDelete(email) {
        emailToDelete = email;
        deletePopup.classList.add("active");
        overlay.classList.add("active");
      }

      document
        .getElementById("confirm-delete")
        .addEventListener("click", async () => {
          if (emailToDelete) {
            await axios.post("/.netlify/functions/delete-application", {
              email: emailToDelete,
            });
            emailToDelete = null;
            fetchApplications();
          }
          closeDeletePopup();
        });

      document.getElementById("cancel-delete").addEventListener("click", () => {
        closeDeletePopup();
      });

      function closeDeletePopup() {
        deletePopup.classList.remove("active");
        overlay.classList.remove("active");
      }

      async function updateStatus(selectElement, email) {
        const newStatus = selectElement.value;
        await axios.post("/.netlify/functions/update-status", {
          email,
          status: newStatus,
        });
      }

      document.getElementById("close-popup").addEventListener("click", () => {
        popup.classList.remove("active");
        overlay.classList.remove("active");
      });

      fetchApplications();
    </script>
    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          await axios.post("/.netlify/functions/collect-data");
        } catch (error) {
          console.error("Failed to log data:", error);
        }
      });
    </script>
  </body>
</html>
